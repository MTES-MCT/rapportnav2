tag_image_docker:
  stage: tag-image-prod
  image: docker:20.10.5
  tags:
    - deployment
  variables:
    HTTP_PROXY: "http://172.27.229.197:8090"
    HTTPS_PROXY: "http://172.27.229.197:8090"
    NO_PROXY: "docker,dockerhost,gitlab-sml.din.developpement-durable.gouv.fr,int-docker01,localhost,127.0.0.1,0.0.0.0,.dsi.damgm.i2"
    DOCKER_HOST: tcp://dockerhost:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: docker:20.10.5-dind
      alias: dockerhost
      entrypoint: ["sh", "-c", "dockerd-entrypoint.sh"]
  script:
    - docker login $NEXUS_DOCKER_REPO -u $NEXUS_USER -p $NEXUS_PWD
    - docker pull $NEXUS_DOCKER_REPO/$PROJECT_NAME:$PROJECT_VERSION
    - docker tag $NEXUS_DOCKER_REPO/$PROJECT_NAME:$PROJECT_VERSION $NEXUS_DOCKER_REPO/$PROJECT_NAME/prod
    - docker image push --all-tags $NEXUS_DOCKER_REPO/$PROJECT_NAME
    - docker logout $NEXUS_DOCKER_REPO
  when: manual


recup_inventaire_prod:
  stage: pre-deploy-prod
  variables:
    ID_PROJET_INVENTAIRE_PROD: 155  #ID du projet GITLAB de l'inventaire de production
  image: alpine/curl
  tags:
    - deployment
  needs:
    - tag_image_docker
  script:
    - cd $CI_PROJECT_DIR
    - curl -H "PRIVATE-TOKEN:$PROJET_INVENTAIRE_PROD_ACCESS_TOKEN" "$CI_API_V4_URL/projects/$ID_PROJET_INVENTAIRE_PROD/repository/files/topologie.ini/raw" --output inventory.ini
  artifacts:
    paths:
      - inventory.ini


deploiement_image_prod:
  stage: deploy-prod
  image: cbhek/ansible-worker:1.0.0
  tags:
    - deployment
  needs:
    - "recup_inventaire_prod"
  variables:
    GIT_STRATEGY: fetch
    GIT_CLEAN_FLAGS: none
  before_script:
    # requis pour que le pipeline du projet appelant ce script ait acc√®s aux scripts ansible
    #- git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/num3-exploitation/deploiement-continu/gitlab-ci/applications/rapportnav-v2/rapportnav-v2
  script:
    - cd ci && ansible-playbook -i ../inventory.ini deploiement_image_docker.yml --extra-vars "env=prod inventory_hostname=$SERVER_ENV_PROD"
  
  
