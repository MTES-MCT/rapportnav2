# TODO Ã  adapter selon le projet
build_projet_gradle:
  stage: build
  image: gradle:8.5-jdk17
  variables:
    HTTP_PROXY: "http://172.27.229.197:8090"
    HTTPS_PROXY: "http://172.27.229.197:8090"
    NO_PROXY: "gitlab-sml.din.developpement-durable.gouv.fr,localhost,127.0.0.1,0.0.0.0,.dsi.damgm.i2"
  script:
    - cd backend
    - chmod +x gradlew
    - HTTP_PROXY_HOST=$(echo $HTTP_PROXY | sed 's/http:\/\/\([^:]*\):.*/\1/')
    - HTTP_PROXY_PORT=$(echo $HTTP_PROXY | sed 's/http:\/\/[^:]*:\([^:]*\)/\1/')
    - HTTPS_PROXY_HOST=$(echo $HTTPS_PROXY | sed 's/http:\/\/\([^:]*\):.*/\1/')
    - HTTPS_PROXY_PORT=$(echo $HTTPS_PROXY | sed 's/http:\/\/[^:]*:\([^:]*\)/\1/')
    - ./gradlew clean assemble \
      -Dhttp.proxyHost=$HTTP_PROXY_HOST \
      -Dhttp.proxyPort=$HTTP_PROXY_PORT \
      -Dhttps.proxyHost=$HTTPS_PROXY_HOST \
      -Dhttps.proxyPort=$HTTPS_PROXY_PORT \
      -Dhttp.nonProxyHosts="$NO_PROXY"
  tags:
    - build
  artifacts:
    name: "Gradle artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    when: on_success
    paths:
      - "backend/build/libs/rapportnav-${PROJECT_VERSION}.jar"
