#####################
# Multi stage build #
#####################

ARG GITHUB_SHA=NO_COMMIT
ARG VERSION=NO_VERSION

########################################
# Build rapportnav backend with maven #
########################################
FROM maven:3.8.5-openjdk-17-slim as run-backend

ARG GITHUB_SHA
ARG VERSION

WORKDIR /tmp/backend
COPY backend/ .

RUN mkdir configurations
COPY infra/configurations/backend/ ./configurations/

RUN mvn dependency:go-offline -B

RUN mvn spring-boot:run  -Dspring-boot.run.profiles="dev"
# -Dspring-boot.run.arguments="--spring.config.additional-location="/tmp/backend/configurations""

CMD exec java -Dspring.config.additional-location="/home/rapportnav/configurations/" -Dspring.profiles.active=$ENV_PROFILE -jar "/home/rapportnav/rapportnav-${VERSION}.jar"




########################################
# Build frontend                       #
########################################
# Stage 1: Build npm dependencies
FROM node:18 AS npm-dependencies
WORKDIR /tmp/frontend
COPY frontend/package.json frontend/package-lock.json ./
RUN npm install

# Stage 2: Build the application
FROM node:18 AS run-frontend
WORKDIR /tmp/frontend
COPY --from=npm-dependencies /tmp/frontend/node_modules ./node_modules
COPY frontend .
RUN npm run dev --mode dev --host

