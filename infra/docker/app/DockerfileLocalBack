########################################
# Dependencies                         #
########################################
# Stage 1: Build backend dependencies
FROM openjdk:17-jdk-alpine AS backend-dependencies

WORKDIR /tmp/backend
# Copy backend Gradle build files
COPY backend/build.gradle.kts backend/settings.gradle.kts backend/gradlew ./
COPY backend/gradle ./gradle
# Resolve and cache dependencies
RUN ./gradlew --no-daemon dependencies


########################################
# Package and Serve on :80             #
########################################
FROM backend-dependencies as backend-run

ENV VERSION=1.0.3
ENV ENV_PROFILE=local

WORKDIR /tmp/backend

COPY backend/ .

# Copy config
COPY infra/configurations/backend ./configurations/

# Expose ports
EXPOSE 80

# Run the backend application
CMD ./gradlew bootRun --args='--spring.profiles.active=local --spring.config.additional-location=/tmp/backend/configurations/'

